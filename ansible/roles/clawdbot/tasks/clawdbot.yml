---
- name: Create Clawdbot directories (structure only, no config files)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ clawdbot_config_dir }}", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/sessions", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/credentials", mode: '0700' }
    - { path: "{{ clawdbot_config_dir }}/data", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/logs", mode: '0755' }

- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  loop:
    - "{{ clawdbot_home }}/.local/share/pnpm"
    - "{{ clawdbot_home }}/.local/share/pnpm/store"
    - "{{ clawdbot_home }}/.local/bin"

- name: Ensure pnpm directories have correct ownership
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.local/share/pnpm"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    recurse: true
    mode: '0755'

- name: Configure pnpm for clawdbot user
  ansible.builtin.shell:
    cmd: |
      pnpm config set global-dir {{ clawdbot_home }}/.local/share/pnpm
      pnpm config set global-bin-dir {{ clawdbot_home }}/.local/bin
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  changed_when: true  # Always consider changed as pnpm config may update

- name: Display installation mode
  ansible.builtin.debug:
    msg: "üì¶ Installation mode: {{ clawdbot_install_mode }}"

# Include appropriate installation method based on mode
- name: Include release installation (pnpm install -g)
  ansible.builtin.include_tasks: clawdbot-release.yml
  when: clawdbot_install_mode == "release"

- name: Include development installation (git clone + build + link)
  ansible.builtin.include_tasks: clawdbot-development.yml
  when: clawdbot_install_mode == "development"

- name: Configure .bashrc for clawdbot user (pnpm config)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    insertafter: EOF

- name: Configure .zshrc for clawdbot user (pnpm config)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    insertafter: EOF

- name: Install poetry via Homebrew
  ansible.builtin.shell:
    cmd: /home/linuxbrew/.linuxbrew/bin/brew install poetry
    executable: /bin/bash
  args:
    creates: /home/linuxbrew/.linuxbrew/bin/poetry
  become: true
  become_user: "{{ clawdbot_user }}"

- name: Create skills directory
  ansible.builtin.file:
    path: "{{ clawdbot_config_dir }}/skills/wayfinder"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'

- name: Copy wayfinder skill to server and unzip
  ansible.builtin.unarchive:
    src: wayfinder.skill
    dest: "{{ clawdbot_config_dir }}/skills/wayfinder"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"

- name: Set environment variables in .bashrc
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Openclaw env"
    block: |
      {% if anthropic_api_key | length > 0 %}
      export ANTHROPIC_API_KEY="{{ anthropic_api_key }}"
      {% endif %}
      {% if openai_api_key | length > 0 %}
      export OPENAI_API_KEY="{{ openai_api_key }}"
      {% endif %}
      {% if gemini_api_key | length > 0 %}
      export GEMINI_API_KEY="{{ gemini_api_key }}"
      {% endif %}
      {% for ch in channels %}
      {% if ch.type == 'telegram' and ch.token is defined and ch.token | length > 0 %}
      export TELEGRAM_BOT_TOKEN="{{ ch.token }}"
      {% endif %}
      {% if ch.type == 'discord' and ch.token is defined and ch.token | length > 0 %}
      export DISCORD_BOT_TOKEN="{{ ch.token }}"
      {% endif %}
      {% endfor %}
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: anthropic_api_key | length > 0 or openai_api_key | length > 0 or gemini_api_key | length > 0 or channels | length > 0

- name: Set environment variables in .zshrc
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Openclaw env"
    block: |
      {% if anthropic_api_key | length > 0 %}
      export ANTHROPIC_API_KEY="{{ anthropic_api_key }}"
      {% endif %}
      {% if openai_api_key | length > 0 %}
      export OPENAI_API_KEY="{{ openai_api_key }}"
      {% endif %}
      {% if gemini_api_key | length > 0 %}
      export GEMINI_API_KEY="{{ gemini_api_key }}"
      {% endif %}
      {% for ch in channels %}
      {% if ch.type == 'telegram' and ch.token is defined and ch.token | length > 0 %}
      export TELEGRAM_BOT_TOKEN="{{ ch.token }}"
      {% endif %}
      {% if ch.type == 'discord' and ch.token is defined and ch.token | length > 0 %}
      export DISCORD_BOT_TOKEN="{{ ch.token }}"
      {% endif %}
      {% endfor %}
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: anthropic_api_key | length > 0 or openai_api_key | length > 0 or gemini_api_key | length > 0 or channels | length > 0

- name: Write environment file for systemd
  ansible.builtin.copy:
    dest: "{{ clawdbot_config_dir }}/credentials/provider.env"
    content: |
      {% if anthropic_api_key | length > 0 %}
      ANTHROPIC_API_KEY={{ anthropic_api_key }}
      {% endif %}
      {% if openai_api_key | length > 0 %}
      OPENAI_API_KEY={{ openai_api_key }}
      {% endif %}
      {% if gemini_api_key | length > 0 %}
      GEMINI_API_KEY={{ gemini_api_key }}
      {% endif %}
      {% for ch in channels %}
      {% if ch.type == 'telegram' and ch.token is defined and ch.token | length > 0 %}
      TELEGRAM_BOT_TOKEN={{ ch.token }}
      {% endif %}
      {% if ch.type == 'discord' and ch.token is defined and ch.token | length > 0 %}
      DISCORD_BOT_TOKEN={{ ch.token }}
      {% endif %}
      {% endfor %}
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0600'
  when: anthropic_api_key | length > 0 or openai_api_key | length > 0 or gemini_api_key | length > 0 or channels | length > 0

- name: Determine API key flag for onboarding
  ansible.builtin.set_fact:
    onboard_key_flag: >-
      {% if anthropic_api_key | length > 0 %}--anthropic-api-key "{{ anthropic_api_key }}"{% elif openai_api_key | length > 0 %}--openai-api-key "{{ openai_api_key }}"{% elif gemini_api_key | length > 0 %}--gemini-api-key "{{ gemini_api_key }}"{% endif %}
    has_any_api_key: "{{ (anthropic_api_key | length > 0) or (openai_api_key | length > 0) or (gemini_api_key | length > 0) }}"

- name: Check openclaw version
  ansible.builtin.shell:
    cmd: "{{ clawdbot_home }}/.local/bin/openclaw --version 2>&1 || echo 'FAILED TO GET VERSION'"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: clawdbot_version_check
  changed_when: false
  failed_when: false

- name: Display openclaw version
  ansible.builtin.debug:
    msg: "Openclaw version: {{ clawdbot_version_check.stdout | default('unknown') }}"

- name: Run openclaw onboard (non-interactive with daemon)
  ansible.builtin.shell:
    cmd: >-
      {{ clawdbot_home }}/.local/bin/openclaw onboard
      --non-interactive
      --accept-risk
      --mode local
      --flow quickstart
      --skip-ui
      --skip-health
      --skip-skills
      --skip-channels
      --install-daemon
      {{ onboard_key_flag | trim }}
      2>&1
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    ANTHROPIC_API_KEY: "{{ anthropic_api_key }}"
    OPENAI_API_KEY: "{{ openai_api_key }}"
    GEMINI_API_KEY: "{{ gemini_api_key }}"
    TELEGRAM_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'telegram' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    DISCORD_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'discord' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  when: has_any_api_key | bool
  register: onboard_result

- name: Display onboard output
  ansible.builtin.debug:
    msg: "{{ onboard_result.stdout | default('no output') }}"
  when: has_any_api_key | bool

- name: Run openclaw doctor --fix
  ansible.builtin.shell:
    cmd: "{{ clawdbot_home }}/.local/bin/openclaw doctor --fix --non-interactive 2>&1"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    ANTHROPIC_API_KEY: "{{ anthropic_api_key }}"
    OPENAI_API_KEY: "{{ openai_api_key }}"
    GEMINI_API_KEY: "{{ gemini_api_key }}"
    TELEGRAM_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'telegram' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    DISCORD_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'discord' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  when: has_any_api_key | bool
  register: doctor_result
  failed_when: false

- name: Display doctor output
  ansible.builtin.debug:
    msg: "{{ doctor_result.stdout | default('no output') }}"
  when: has_any_api_key | bool

- name: Install Telegram channel plugin
  ansible.builtin.shell:
    cmd: "pnpm install -g @openclaw/channel-telegram@latest 2>&1"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    TELEGRAM_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'telegram' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  when: channels | selectattr('type', 'equalto', 'telegram') | list | length > 0
  register: telegram_plugin_result
  failed_when: false

- name: Display Telegram plugin install output
  ansible.builtin.debug:
    msg: "{{ telegram_plugin_result.stdout | default(telegram_plugin_result.stderr | default('no output')) }}"
  when: channels | selectattr('type', 'equalto', 'telegram') | list | length > 0

- name: Install Discord channel plugin
  ansible.builtin.shell:
    cmd: "pnpm install -g @openclaw/channel-discord@latest 2>&1"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    DISCORD_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'discord' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  when: channels | selectattr('type', 'equalto', 'discord') | list | length > 0
  register: discord_plugin_result
  failed_when: false

- name: Display Discord plugin install output
  ansible.builtin.debug:
    msg: "{{ discord_plugin_result.stdout | default(discord_plugin_result.stderr | default('no output')) }}"
  when: channels | selectattr('type', 'equalto', 'discord') | list | length > 0

- name: Add channels
  ansible.builtin.shell:
    cmd: >-
      {{ clawdbot_home }}/.local/bin/openclaw channels add
      --channel {{ item.type }}
      {% if item.token is defined and item.token | length > 0 %}--token "{{ item.token }}"{% endif %}
      {% if item.name is defined and item.name | length > 0 %}--name "{{ item.name }}"{% endif %}
      {% if item.account is defined and item.account | length > 0 %}--account "{{ item.account }}"{% endif %}
      2>&1
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    TELEGRAM_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'telegram' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    DISCORD_BOT_TOKEN: "{% for ch in channels %}{% if ch.type == 'discord' and ch.token is defined %}{{ ch.token }}{% endif %}{% endfor %}"
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  loop: "{{ channels }}"
  when: channels | length > 0
  register: channel_add_results

- name: Display channel add output
  ansible.builtin.debug:
    msg: "Channel {{ item.item.type }}: {{ item.stdout | default('no output') }}"
  loop: "{{ channel_add_results.results | default([]) }}"
  when: channels | length > 0 and item.stdout is defined

- name: Display configuration note
  ansible.builtin.debug:
    msg: |
      ‚úÖ Openclaw onboarding complete. Gateway daemon installed and started.
  when: has_any_api_key | bool

- name: Display manual setup note
  ansible.builtin.debug:
    msg: |
      ‚ÑπÔ∏è  Openclaw is installed but NOT configured yet (no API key provided).

      Next steps (run as clawdbot user):
      1. Switch user: sudo su - clawdbot
      2. Run onboarding: openclaw onboard
  when: not (has_any_api_key | bool)
