---
# Main system tools orchestration - delegates to OS-specific tasks

- name: Include Linux system tools installation
  ansible.builtin.include_tasks: system-tools-linux.yml
  when: ansible_os_family == 'Debian'

- name: Include macOS system tools installation
  ansible.builtin.include_tasks: system-tools-macos.yml
  when: ansible_os_family == 'Darwin'

- name: Display unsupported OS warning
  ansible.builtin.fail:
    msg: "Unsupported OS family: {{ ansible_os_family }}. Only Debian/Ubuntu and macOS are supported."
  when: ansible_os_family not in ['Debian', 'Darwin']

# Common tasks for all operating systems

- name: Install oh-my-zsh for clawdbot user
  ansible.builtin.shell:
    cmd: |
      sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    creates: "{{ clawdbot_home }}/.oh-my-zsh"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    HOME: "{{ clawdbot_home }}"
    USER: "{{ clawdbot_user }}"

## Shell profile configuration - MUST come after oh-my-zsh which overwrites .zshrc

- name: Configure .bashrc for clawdbot user (Linux)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot config"
    block: |
      # Enable 256 colors
      export TERM=xterm-256color
      export COLORTERM=truecolor

      # Add Homebrew to PATH (Linux)
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      # Add pnpm to PATH
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"

      # Color support for common tools
      export CLICOLOR=1
      export LS_COLORS='di=34:ln=35:so=32:pi=33:ex=31:bd=34;46:cd=34;43:su=30;41:sg=30;46:tw=30;42:ow=30;43'

      # Aliases
      alias ls='ls --color=auto'
      alias grep='grep --color=auto'
      alias ll='ls -lah'
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: ansible_os_family == 'Debian'

- name: Configure .zshrc for clawdbot user (Linux)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot config"
    block: |
      # Enable 256 colors
      export TERM=xterm-256color
      export COLORTERM=truecolor

      # Add Homebrew to PATH (Linux)
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      # Add pnpm to PATH
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"

      # Color support for common tools
      export CLICOLOR=1
      export LS_COLORS='di=34:ln=35:so=32:pi=33:ex=31:bd=34;46:cd=34;43:su=30;41:sg=30;46:tw=30;42:ow=30;43'

      # Aliases
      alias ls='ls --color=auto'
      alias grep='grep --color=auto'
      alias ll='ls -lah'
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: ansible_os_family == 'Debian'

- name: Configure git globally
  community.general.git_config:
    name: "{{ item.name }}"
    scope: global
    value: "{{ item.value }}"
  loop:
    - { name: 'init.defaultBranch', value: 'main' }
    - { name: 'pull.rebase', value: 'false' }
    - { name: 'core.editor', value: 'vim' }
    - { name: 'color.ui', value: 'auto' }
    - { name: 'alias.st', value: 'status' }
    - { name: 'alias.co', value: 'checkout' }
    - { name: 'alias.br', value: 'branch' }
    - { name: 'alias.ci', value: 'commit' }
    - { name: 'alias.unstage', value: 'reset HEAD --' }
    - { name: 'alias.last', value: 'log -1 HEAD' }
    - { name: 'alias.lg', value: 'log --oneline --graph --decorate --all' }
